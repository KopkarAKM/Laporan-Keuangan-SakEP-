<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Akuntansi Koperasi (SAK EP 2025)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel untuk JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "firebase/app": "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1?external=react"
      }
    }
    </script>

    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #10B981; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #059669; }
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, deleteDoc, doc, where, getDocs, writeBatch } from 'firebase/firestore';
        import { LayoutDashboard, BookOpen, FileText, PieChart, PlusCircle, Trash2, Save, Menu, X, ArrowUpRight, ArrowDownRight, Settings, Filter } from 'lucide-react';

        // --- KONFIGURASI FIREBASE ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DATA MASTER AWAL (Hanya untuk inisialisasi/Seeding) ---
        const INITIAL_MASTER_DATA = [
            // ASET (Normal: Debit)
            { kode: 'I.1.1.1', nama: 'Kas Kecil AKM', kategori: 'Aset', saldoNormal: 'Debit' },
            { kode: 'I.1.1.2', nama: 'Kas Kecil Tiket', kategori: 'Aset', saldoNormal: 'Debit' },
            { kode: 'I.1.1.2.1', nama: 'Kas Kecil Adamart', kategori: 'Aset', saldoNormal: 'Debit' },
            { kode: 'I.1.1.2.2', nama: 'Kas belum disetor', kategori: 'Aset', saldoNormal: 'Debit' },
            { kode: 'I.1.2.1', nama: 'Bank Mandiri Induk AKM', kategori: 'Aset', saldoNormal: 'Debit' },
            { kode: 'I.1.2.2', nama: 'Bank Mandiri Induk Adamart', kategori: 'Aset', saldoNormal: 'Debit' },
            { kode: 'I.1.2.3', nama: 'Bank Mandiri Giro', kategori: 'Aset', saldoNormal: 'Debit' },
            { kode: 'I.1.2.4', nama: 'BNI Giro', kategori: 'Aset', saldoNormal: 'Debit' },
            { kode: 'I.1.2.5', nama: 'BRI Giro', kategori: 'Aset', saldoNormal: 'Debit' },
            { kode: 'I.2.1', nama: 'Piutang Usaha', kategori: 'Aset', saldoNormal: 'Debit' },
            
            // KEWAJIBAN (Normal: Kredit)
            { kode: 'II.1.1', nama: 'Utang Usaha', kategori: 'Kewajiban', saldoNormal: 'Kredit' },
            { kode: 'II.1.2', nama: 'Simpanan Sukarela Anggota', kategori: 'Kewajiban', saldoNormal: 'Kredit' },
            
            // EKUITAS (Normal: Kredit)
            { kode: 'III.1.1', nama: 'Simpanan Pokok', kategori: 'Ekuitas', saldoNormal: 'Kredit' },
            { kode: 'III.1.2', nama: 'Simpanan Wajib', kategori: 'Ekuitas', saldoNormal: 'Kredit' },
            { kode: 'III.1.3', nama: 'SHU Tahun Lalu', kategori: 'Ekuitas', saldoNormal: 'Kredit' },
            { kode: 'III.1.4', nama: 'SHU Tahun Berjalan', kategori: 'Ekuitas', saldoNormal: 'Kredit' },

            // PENDAPATAN (Normal: Kredit)
            { kode: 'IV.1.1', nama: 'Pendapatan Unit Toko', kategori: 'Pendapatan', saldoNormal: 'Kredit' },
            { kode: 'IV.1.2', nama: 'Pendapatan Unit Simpan Pinjam', kategori: 'Pendapatan', saldoNormal: 'Kredit' },

            // BEBAN (Normal: Debit)
            { kode: 'V.3.8', nama: 'Beban PDAM', kategori: 'Beban', saldoNormal: 'Debit' },
            { kode: 'V.3.9', nama: 'Beban Telpon dan Internet', kategori: 'Beban', saldoNormal: 'Debit' },
            { kode: 'V.3.10', nama: 'Beban TV Kabel', kategori: 'Beban', saldoNormal: 'Debit' },
            { kode: 'V.3.13', nama: 'Biaya Perbaikan dan Pemeliharaan Kendaraan', kategori: 'Beban', saldoNormal: 'Debit' },
            { kode: 'V.3.14', nama: 'Biaya Perbaikan dan Pemeliharaan Peralatan', kategori: 'Beban', saldoNormal: 'Debit' },
            { kode: 'V.3.15', nama: 'Biaya Perlengkapan', kategori: 'Beban', saldoNormal: 'Debit' },
            { kode: 'V.3.24', nama: 'Beban GPS', kategori: 'Beban', saldoNormal: 'Debit' },
            { kode: 'V.5.1', nama: 'Beban Administrasi dan Umum', kategori: 'Beban', saldoNormal: 'Debit' },
            { kode: 'V.5.2', nama: 'Beban Zakat', kategori: 'Beban', saldoNormal: 'Debit' },
            { kode: 'V.5.3', nama: 'Beban Pajak', kategori: 'Beban', saldoNormal: 'Debit' }
        ];

        // --- KOMPONEN UTILITAS ---
        const formatRupiah = (number) => {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(number);
        };

        const Modal = ({ isOpen, onClose, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-md overflow-hidden">
                        <div className="p-4 border-b flex justify-between items-center bg-emerald-600 text-white">
                            <h3 className="font-bold">Informasi</h3>
                            <button onClick={onClose}><X size={20} /></button>
                        </div>
                        <div className="p-6">{children}</div>
                    </div>
                </div>
            );
        };

        // --- KOMPONEN UTAMA ---

        // 1. DASHBOARD
        const Dashboard = ({ user, masterAkun }) => {
            const [stats, setStats] = useState({ aset: 0, kewajiban: 0, ekuitas: 0, pendapatan: 0, beban: 0, shu: 0 });
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (!user || masterAkun.length === 0) return;
                
                // Gunakan tahun berjalan sebagai default view dashboard
                const currentYear = new Date().getFullYear();
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'jurnal_umum'));
                
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    let tempStats = { aset: 0, kewajiban: 0, ekuitas: 0, pendapatan: 0, beban: 0 };
                    
                    snapshot.docs.forEach(doc => {
                        const t = doc.data();
                        const val = parseFloat(t.nominal || 0);
                        const akun = masterAkun.find(a => a.kode === t.kodeAkun);
                        
                        if (akun) {
                            const prefix = akun.kode.split('.')[0];
                            // Logika Saldo: Jika posisi transaksi == saldo normal, menambah. Jika beda, mengurangi.
                            let multiplier = (t.posisi === akun.saldoNormal) ? 1 : -1;
                            
                            if (prefix === 'I') tempStats.aset += (val * multiplier);
                            else if (prefix === 'II') tempStats.kewajiban += (val * multiplier);
                            else if (prefix === 'III') tempStats.ekuitas += (val * multiplier);
                            else if (prefix === 'IV') tempStats.pendapatan += (val * multiplier);
                            else if (prefix === 'V') tempStats.beban += (val * multiplier);
                        }
                    });

                    tempStats.shu = tempStats.pendapatan - tempStats.beban;
                    setStats(tempStats);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [user, masterAkun]);

            const cards = [
                { title: 'Total Aset', value: stats.aset, color: 'bg-blue-500', icon: <PieChart className="text-white opacity-80" size={24}/> },
                { title: 'SHU Berjalan', value: stats.shu, color: stats.shu >= 0 ? 'bg-emerald-500' : 'bg-red-500', icon: <BookOpen className="text-white opacity-80" size={24}/> },
                { title: 'Pendapatan', value: stats.pendapatan, color: 'bg-indigo-500', icon: <ArrowUpRight className="text-white opacity-80" size={24}/> },
                { title: 'Beban Operasional', value: stats.beban, color: 'bg-orange-500', icon: <ArrowDownRight className="text-white opacity-80" size={24}/> },
            ];

            return (
                <div className="space-y-6">
                    <h2 className="text-2xl font-bold text-gray-800">Ringkasan Eksekutif</h2>
                    {loading ? (
                        <div className="text-gray-500 animate-pulse">Menghitung data akuntansi...</div>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            {cards.map((card, idx) => (
                                <div key={idx} className={`${card.color} rounded-lg shadow-lg p-5 text-white transform transition hover:scale-105`}>
                                    <div className="flex justify-between items-start">
                                        <div>
                                            <p className="text-sm font-medium opacity-90">{card.title}</p>
                                            <h3 className="text-xl lg:text-2xl font-bold mt-1">{formatRupiah(card.value)}</h3>
                                        </div>
                                        <div className="p-2 bg-white bg-opacity-20 rounded-lg">
                                            {card.icon}
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // 2. INPUT JURNAL
        const JournalEntry = ({ user, masterAkun }) => {
            const [entries, setEntries] = useState([{ akun: '', posisi: 'Debit', nominal: '' }, { akun: '', posisi: 'Kredit', nominal: '' }]);
            const [tanggal, setTanggal] = useState(new Date().toISOString().split('T')[0]);
            const [keterangan, setKeterangan] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [modalMsg, setModalMsg] = useState('');

            const handleEntryChange = (index, field, value) => {
                const newEntries = [...entries];
                newEntries[index][field] = value;
                setEntries(newEntries);
            };

            const addRow = () => setEntries([...entries, { akun: '', posisi: 'Debit', nominal: '' }]);
            
            const removeRow = (index) => {
                if (entries.length > 2) {
                    const newEntries = entries.filter((_, i) => i !== index);
                    setEntries(newEntries);
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!user) return;
                
                let totalDebit = 0;
                let totalKredit = 0;

                entries.forEach(ent => {
                    const val = parseFloat(ent.nominal) || 0;
                    if (ent.posisi === 'Debit') totalDebit += val;
                    else totalKredit += val;
                });

                if (Math.abs(totalDebit - totalKredit) > 1) { 
                    setModalMsg(`Jurnal tidak seimbang! Debit: ${formatRupiah(totalDebit)}, Kredit: ${formatRupiah(totalKredit)}`);
                    return;
                }

                if (totalDebit === 0) {
                    setModalMsg("Nominal tidak boleh nol.");
                    return;
                }

                setIsSubmitting(true);
                try {
                    const batchId = Date.now().toString(); 
                    const promises = entries.map(ent => {
                        const akunData = masterAkun.find(a => a.kode === ent.akun);
                        return addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'jurnal_umum'), {
                            tanggal,
                            keterangan,
                            kodeAkun: ent.akun,
                            namaAkun: akunData ? akunData.nama : 'Unknown',
                            posisi: ent.posisi,
                            nominal: parseFloat(ent.nominal),
                            batchId,
                            createdAt: new Date()
                        });
                    });

                    await Promise.all(promises);
                    setModalMsg("Jurnal berhasil disimpan.");
                    setEntries([{ akun: '', posisi: 'Debit', nominal: '' }, { akun: '', posisi: 'Kredit', nominal: '' }]);
                    setKeterangan('');
                } catch (error) {
                    console.error(error);
                    setModalMsg("Gagal menyimpan jurnal.");
                }
                setIsSubmitting(false);
            };

            return (
                <div className="bg-white rounded-lg shadow p-6">
                    <h2 className="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                        <PlusCircle size={20} className="text-emerald-600"/>
                        Input Jurnal Umum
                    </h2>
                    
                    <form onSubmit={handleSubmit} className="space-y-6">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Tanggal</label>
                                <input type="date" required value={tanggal} onChange={(e) => setTanggal(e.target.value)} className="mt-1 block w-full rounded border-gray-300 shadow-sm border p-2"/>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Keterangan / Bukti</label>
                                <input type="text" required placeholder="Cth: Saldo Awal 2025 / Bayar Listrik" value={keterangan} onChange={(e) => setKeterangan(e.target.value)} className="mt-1 block w-full rounded border-gray-300 shadow-sm border p-2"/>
                            </div>
                        </div>

                        <div className="border rounded-md overflow-hidden">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Akun</th>
                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Posisi</th>
                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nominal (Rp)</th>
                                        <th className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {entries.map((row, idx) => (
                                        <tr key={idx}>
                                            <td className="px-4 py-2">
                                                <select value={row.akun} onChange={(e) => handleEntryChange(idx, 'akun', e.target.value)} className="w-full border p-1 rounded" required>
                                                    <option value="">-- Pilih Akun --</option>
                                                    {masterAkun.map(acc => (
                                                        <option key={acc.kode} value={acc.kode}>{acc.kode} - {acc.nama}</option>
                                                    ))}
                                                </select>
                                            </td>
                                            <td className="px-4 py-2">
                                                <select value={row.posisi} onChange={(e) => handleEntryChange(idx, 'posisi', e.target.value)} className="w-full border p-1 rounded">
                                                    <option value="Debit">Debit</option>
                                                    <option value="Kredit">Kredit</option>
                                                </select>
                                            </td>
                                            <td className="px-4 py-2">
                                                <input type="number" min="0" value={row.nominal} onChange={(e) => handleEntryChange(idx, 'nominal', e.target.value)} className="w-full border p-1 rounded" required/>
                                            </td>
                                            <td className="px-4 py-2 text-center">
                                                <button type="button" onClick={() => removeRow(idx)} className="text-red-600 hover:text-red-900"><Trash2 size={16} /></button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>

                        <div className="flex justify-between items-center">
                            <button type="button" onClick={addRow} className="text-sm text-emerald-600 font-medium hover:text-emerald-800 flex items-center gap-1"><PlusCircle size={16} /> Tambah Baris</button>
                            <div className="flex gap-4 items-center">
                                <div className="text-sm font-bold text-gray-700">Total D: {formatRupiah(entries.filter(e => e.posisi === 'Debit').reduce((a, b) => a + (parseFloat(b.nominal)||0), 0))}</div>
                                <div className="text-sm font-bold text-gray-700">Total K: {formatRupiah(entries.filter(e => e.posisi === 'Kredit').reduce((a, b) => a + (parseFloat(b.nominal)||0), 0))}</div>
                            </div>
                        </div>

                        <div className="flex justify-end pt-4">
                            <button type="submit" disabled={isSubmitting} className={`flex items-center gap-2 px-6 py-2 rounded-md text-white font-medium ${isSubmitting ? 'bg-gray-400' : 'bg-emerald-600 hover:bg-emerald-700'}`}>
                                <Save size={18} /> {isSubmitting ? 'Menyimpan...' : 'Simpan Transaksi'}
                            </button>
                        </div>
                    </form>
                    <Modal isOpen={!!modalMsg} onClose={() => setModalMsg('')}>
                        <p className="text-gray-700">{modalMsg}</p>
                        <button onClick={() => setModalMsg('')} className="mt-4 w-full bg-emerald-600 text-white py-2 rounded">OK</button>
                    </Modal>
                </div>
            );
        };

        // 3. BUKU BESAR
        const Ledger = ({ user, masterAkun }) => {
            const [selectedAkun, setSelectedAkun] = useState('');
            const [transaksi, setTransaksi] = useState([]);
            const [saldoAkhir, setSaldoAkhir] = useState(0);

            useEffect(() => {
                if (!user || !selectedAkun) {
                    setTransaksi([]);
                    setSaldoAkhir(0);
                    return;
                }

                const akunInfo = masterAkun.find(a => a.kode === selectedAkun);
                if (!akunInfo) return;

                const q = query(
                    collection(db, 'artifacts', appId, 'public', 'data', 'jurnal_umum'),
                    where('kodeAkun', '==', selectedAkun),
                    orderBy('tanggal', 'asc')
                );

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    let runningBalance = 0;
                    const data = [];
                    
                    snapshot.docs.forEach(doc => {
                        const t = doc.data();
                        const nominal = parseFloat(t.nominal);
                        
                        // Logika saldo berjalan berdasarkan Saldo Normal Akun
                        if (t.posisi === akunInfo.saldoNormal) {
                            runningBalance += nominal;
                        } else {
                            runningBalance -= nominal;
                        }

                        data.push({ id: doc.id, ...t, saldo: runningBalance });
                    });
                    
                    setTransaksi(data);
                    setSaldoAkhir(runningBalance);
                }, (error) => console.error("Ledger error:", error));

                return () => unsubscribe();
            }, [user, selectedAkun, masterAkun]);

            return (
                <div className="space-y-6">
                    <div className="bg-white p-4 rounded-lg shadow flex items-center gap-4">
                        <label className="font-medium text-gray-700">Pilih Akun:</label>
                        <select value={selectedAkun} onChange={(e) => setSelectedAkun(e.target.value)} className="border p-2 rounded flex-1 max-w-md">
                            <option value="">-- Pilih Buku Besar --</option>
                            {masterAkun.map(acc => (
                                <option key={acc.kode} value={acc.kode}>{acc.kode} - {acc.nama}</option>
                            ))}
                        </select>
                    </div>

                    {selectedAkun && (
                        <div className="bg-white rounded-lg shadow overflow-hidden">
                            <div className="p-4 border-b bg-gray-50 flex justify-between items-center">
                                <h3 className="font-bold text-gray-700">{masterAkun.find(a=>a.kode===selectedAkun)?.nama}</h3>
                                <span className="text-emerald-700 font-bold bg-emerald-100 px-3 py-1 rounded-full">Saldo Akhir: {formatRupiah(saldoAkhir)}</span>
                            </div>
                            <div className="overflow-x-auto">
                                <table className="min-w-full divide-y divide-gray-200">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tanggal</th>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Keterangan</th>
                                            <th className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Debit</th>
                                            <th className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Kredit</th>
                                            <th className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Saldo</th>
                                        </tr>
                                    </thead>
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        {transaksi.length === 0 ? (
                                            <tr><td colSpan="5" className="px-4 py-4 text-center text-gray-500">Belum ada transaksi</td></tr>
                                        ) : (
                                            transaksi.map((t) => (
                                                <tr key={t.id} className="hover:bg-gray-50">
                                                    <td className="px-4 py-2 text-sm text-gray-900">{t.tanggal}</td>
                                                    <td className="px-4 py-2 text-sm text-gray-900">{t.keterangan}</td>
                                                    <td className="px-4 py-2 text-sm text-right text-gray-600">{t.posisi === 'Debit' ? formatRupiah(t.nominal) : '-'}</td>
                                                    <td className="px-4 py-2 text-sm text-right text-gray-600">{t.posisi === 'Kredit' ? formatRupiah(t.nominal) : '-'}</td>
                                                    <td className="px-4 py-2 text-sm text-right font-medium text-gray-900">{formatRupiah(t.saldo)}</td>
                                                </tr>
                                            ))
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // 4. LAPORAN KEUANGAN
        const Reports = ({ user, masterAkun }) => {
            const [reportType, setReportType] = useState('neraca');
            const [startDate, setStartDate] = useState(`${new Date().getFullYear()}-01-01`);
            const [endDate, setEndDate] = useState(new Date().toISOString().split('T')[0]);
            const [dataLaporan, setDataLaporan] = useState([]);

            useEffect(() => {
                if (!user || masterAkun.length === 0) return;

                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'jurnal_umum'));
                
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const balances = {};
                    
                    masterAkun.forEach(acc => {
                        balances[acc.kode] = { ...acc, saldo: 0 };
                    });

                    snapshot.docs.forEach(doc => {
                        const t = doc.data();
                        const tDate = new Date(t.tanggal);
                        const sDate = new Date(startDate);
                        const eDate = new Date(endDate);
                        
                        // Filter Logika Periode
                        let include = false;
                        const prefix = t.kodeAkun.split('.')[0];
                        
                        // Neraca: Kumulatif sampai EndDate
                        if (['I', 'II', 'III'].includes(prefix)) {
                            if (tDate <= eDate) include = true;
                        } 
                        // Laba Rugi: Antara StartDate dan EndDate
                        else {
                            if (tDate >= sDate && tDate <= eDate) include = true;
                        }

                        if (include && balances[t.kodeAkun]) {
                            const acc = balances[t.kodeAkun];
                            const nominal = parseFloat(t.nominal);
                            if (t.posisi === acc.saldoNormal) acc.saldo += nominal;
                            else acc.saldo -= nominal;
                        }
                    });

                    setDataLaporan(Object.values(balances));
                });

                return () => unsubscribe();
            }, [user, masterAkun, startDate, endDate]);

            const neracaItems = useMemo(() => dataLaporan.filter(item => ['I', 'II', 'III'].includes(item.kode.split('.')[0])), [dataLaporan]);
            const labaRugiItems = useMemo(() => dataLaporan.filter(item => ['IV', 'V'].includes(item.kode.split('.')[0])), [dataLaporan]);

            const totalAset = neracaItems.filter(i => i.kode.startsWith('I')).reduce((a, b) => a + b.saldo, 0);
            const totalLiabilitas = neracaItems.filter(i => i.kode.startsWith('II')).reduce((a, b) => a + b.saldo, 0);
            const totalEkuitas = neracaItems.filter(i => i.kode.startsWith('III')).reduce((a, b) => a + b.saldo, 0);
            
            const totalPendapatan = labaRugiItems.filter(i => i.kode.startsWith('IV')).reduce((a, b) => a + b.saldo, 0);
            const totalBeban = labaRugiItems.filter(i => i.kode.startsWith('V')).reduce((a, b) => a + b.saldo, 0);
            const shuBersih = totalPendapatan - totalBeban;

            return (
                <div className="space-y-6">
                    <div className="bg-white p-4 rounded-lg shadow mb-6">
                         <h3 className="font-bold text-gray-700 mb-2 flex items-center gap-2"><Filter size={18}/> Filter Periode Laporan</h3>
                         <div className="flex gap-4 items-center">
                            <div>
                                <label className="text-xs text-gray-500 block">Dari Tanggal</label>
                                <input type="date" value={startDate} onChange={e => setStartDate(e.target.value)} className="border p-1 rounded text-sm"/>
                            </div>
                            <div>
                                <label className="text-xs text-gray-500 block">Sampai Tanggal</label>
                                <input type="date" value={endDate} onChange={e => setEndDate(e.target.value)} className="border p-1 rounded text-sm"/>
                            </div>
                         </div>
                    </div>

                    <div className="flex space-x-2 border-b">
                        <button className={`py-2 px-4 font-medium ${reportType === 'neraca' ? 'text-emerald-600 border-b-2 border-emerald-600' : 'text-gray-500'}`} onClick={() => setReportType('neraca')}>Posisi Keuangan (Neraca)</button>
                        <button className={`py-2 px-4 font-medium ${reportType === 'labarugi' ? 'text-emerald-600 border-b-2 border-emerald-600' : 'text-gray-500'}`} onClick={() => setReportType('labarugi')}>Hasil Usaha (Laba Rugi)</button>
                    </div>

                    <div className="bg-white p-8 rounded-lg shadow min-h-[500px] border border-gray-200">
                        <div className="text-center mb-8">
                            <h2 className="text-xl font-bold text-gray-800">KOPERASI KARYAWAN AKM</h2>
                            <h3 className="text-lg font-medium text-gray-600">{reportType === 'neraca' ? 'LAPORAN POSISI KEUANGAN' : 'LAPORAN HASIL USAHA'}</h3>
                            <p className="text-sm text-gray-500">
                                {reportType === 'neraca' ? `Per ${new Date(endDate).toLocaleDateString('id-ID')}` : `Periode ${new Date(startDate).toLocaleDateString('id-ID')} s/d ${new Date(endDate).toLocaleDateString('id-ID')}`}
                            </p>
                        </div>

                        {reportType === 'neraca' ? (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div>
                                    <h4 className="font-bold text-emerald-700 border-b mb-2 pb-1">ASET (AKTIVA)</h4>
                                    <table className="w-full text-sm">
                                        <tbody>
                                            {neracaItems.filter(i => i.kode.startsWith('I')).map(item => (
                                                <tr key={item.kode} className="border-b border-gray-50">
                                                    <td className="py-1 text-gray-600 pl-2">{item.kode} - {item.nama}</td>
                                                    <td className="py-1 text-right font-medium">{formatRupiah(item.saldo)}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                        <tfoot className="font-bold bg-gray-50">
                                            <tr><td className="py-2">TOTAL ASET</td><td className="py-2 text-right">{formatRupiah(totalAset)}</td></tr>
                                        </tfoot>
                                    </table>
                                </div>
                                <div>
                                    <h4 className="font-bold text-emerald-700 border-b mb-2 pb-1">LIABILITAS & EKUITAS</h4>
                                    <table className="w-full text-sm mb-6">
                                        <thead><tr><th colSpan="2" className="text-left text-xs font-bold text-gray-500 uppercase py-1">Liabilitas</th></tr></thead>
                                        <tbody>
                                            {neracaItems.filter(i => i.kode.startsWith('II')).map(item => (
                                                <tr key={item.kode} className="border-b border-gray-50">
                                                    <td className="py-1 text-gray-600 pl-2">{item.nama}</td>
                                                    <td className="py-1 text-right font-medium">{formatRupiah(item.saldo)}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                    <table className="w-full text-sm">
                                        <thead><tr><th colSpan="2" className="text-left text-xs font-bold text-gray-500 uppercase py-1">Ekuitas</th></tr></thead>
                                        <tbody>
                                            {neracaItems.filter(i => i.kode.startsWith('III')).map(item => (
                                                <tr key={item.kode} className="border-b border-gray-50">
                                                    <td className="py-1 text-gray-600 pl-2">{item.nama}</td>
                                                    <td className="py-1 text-right font-medium">{formatRupiah(item.saldo)}</td>
                                                </tr>
                                            ))}
                                            <tr className="bg-emerald-50">
                                                <td className="py-1 text-emerald-800 pl-2 font-bold">SHU Tahun Berjalan (Net)</td>
                                                <td className="py-1 text-right font-bold text-emerald-800">{formatRupiah(shuBersih)}</td>
                                            </tr>
                                        </tbody>
                                        <tfoot className="font-bold bg-gray-50 border-t-2 border-gray-200 mt-2">
                                            <tr><td className="py-2">TOTAL PASIVA</td><td className="py-2 text-right">{formatRupiah(totalLiabilitas + totalEkuitas + shuBersih)}</td></tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        ) : (
                            <div className="max-w-2xl mx-auto">
                                <h4 className="font-bold text-emerald-700 border-b mb-2 pb-1">PENDAPATAN</h4>
                                <table className="w-full text-sm mb-6">
                                    <tbody>
                                        {labaRugiItems.filter(i => i.kode.startsWith('IV')).map(item => (
                                            <tr key={item.kode} className="border-b border-gray-50">
                                                <td className="py-1 text-gray-600 pl-2">{item.kode} - {item.nama}</td>
                                                <td className="py-1 text-right font-medium">{formatRupiah(item.saldo)}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                    <tfoot className="font-bold bg-gray-50">
                                        <tr><td className="py-2">Total Pendapatan</td><td className="py-2 text-right">{formatRupiah(totalPendapatan)}</td></tr>
                                    </tfoot>
                                </table>
                                <h4 className="font-bold text-red-700 border-b mb-2 pb-1">BEBAN OPERASIONAL</h4>
                                <table className="w-full text-sm mb-6">
                                    <tbody>
                                        {labaRugiItems.filter(i => i.kode.startsWith('V')).map(item => (
                                            <tr key={item.kode} className="border-b border-gray-50">
                                                <td className="py-1 text-gray-600 pl-2">{item.kode} - {item.nama}</td>
                                                <td className="py-1 text-right font-medium">{formatRupiah(item.saldo)}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                    <tfoot className="font-bold bg-gray-50">
                                        <tr><td className="py-2">Total Beban</td><td className="py-2 text-right">{formatRupiah(totalBeban)}</td></tr>
                                    </tfoot>
                                </table>
                                <div className="mt-8 p-4 bg-emerald-100 rounded-lg flex justify-between items-center border border-emerald-200">
                                    <span className="font-bold text-emerald-900 text-lg">SISA HASIL USAHA (SHU)</span>
                                    <span className="font-bold text-emerald-900 text-2xl">{formatRupiah(shuBersih)}</span>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // 5. PENGATURAN (MANAJEMEN AKUN)
        const SettingsPage = ({ user, masterAkun }) => {
            const [newAkun, setNewAkun] = useState({ kode: '', nama: '', kategori: 'Aset', saldoNormal: 'Debit' });

            const handleAdd = async (e) => {
                e.preventDefault();
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'master_akun'), newAkun);
                    setNewAkun({ kode: '', nama: '', kategori: 'Aset', saldoNormal: 'Debit' });
                    alert("Akun berhasil ditambahkan!");
                } catch(err) {
                    console.error(err);
                    alert("Gagal menambah akun.");
                }
            };

            const handleDelete = async (id) => {
                if(confirm("Yakin hapus akun ini?")) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'master_akun', id));
                }
            };

            return (
                <div className="bg-white p-6 rounded-lg shadow">
                    <h2 className="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2"><Settings size={20} className="text-emerald-600"/> Manajemen Akun (Chart of Accounts)</h2>
                    
                    <form onSubmit={handleAdd} className="bg-gray-50 p-4 rounded mb-6 border border-gray-200">
                        <h4 className="font-bold text-sm mb-3">Tambah Akun Baru</h4>
                        <div className="grid grid-cols-1 md:grid-cols-5 gap-2">
                            <input type="text" placeholder="Kode (Mis: V.1.1)" value={newAkun.kode} onChange={e=>setNewAkun({...newAkun, kode:e.target.value})} className="border p-2 rounded text-sm" required/>
                            <input type="text" placeholder="Nama Akun" value={newAkun.nama} onChange={e=>setNewAkun({...newAkun, nama:e.target.value})} className="border p-2 rounded text-sm md:col-span-2" required/>
                            <select value={newAkun.kategori} onChange={e=>setNewAkun({...newAkun, kategori:e.target.value})} className="border p-2 rounded text-sm">
                                <option value="Aset">Aset</option><option value="Kewajiban">Kewajiban</option><option value="Ekuitas">Ekuitas</option><option value="Pendapatan">Pendapatan</option><option value="Beban">Beban</option>
                            </select>
                            <select value={newAkun.saldoNormal} onChange={e=>setNewAkun({...newAkun, saldoNormal:e.target.value})} className="border p-2 rounded text-sm">
                                <option value="Debit">Normal Debit</option><option value="Kredit">Normal Kredit</option>
                            </select>
                        </div>
                        <button type="submit" className="mt-2 bg-emerald-600 text-white px-4 py-1 rounded text-sm hover:bg-emerald-700">Simpan Akun</button>
                    </form>

                    <div className="overflow-x-auto max-h-[500px]">
                        <table className="w-full text-sm">
                            <thead className="bg-emerald-800 text-white sticky top-0">
                                <tr>
                                    <th className="p-2 text-left">Kode</th>
                                    <th className="p-2 text-left">Nama Akun</th>
                                    <th className="p-2 text-left">Kategori</th>
                                    <th className="p-2 text-left">Saldo Normal</th>
                                    <th className="p-2 text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y">
                                {masterAkun.sort((a,b)=> a.kode.localeCompare(b.kode)).map(acc => (
                                    <tr key={acc.id} className="hover:bg-gray-50">
                                        <td className="p-2">{acc.kode}</td>
                                        <td className="p-2">{acc.nama}</td>
                                        <td className="p-2">{acc.kategori}</td>
                                        <td className="p-2"><span className={`px-2 py-0.5 rounded text-xs ${acc.saldoNormal==='Debit'?'bg-blue-100 text-blue-800':'bg-orange-100 text-orange-800'}`}>{acc.saldoNormal}</span></td>
                                        <td className="p-2 text-center">
                                            <button onClick={()=>handleDelete(acc.id)} className="text-red-500 hover:text-red-700"><Trash2 size={14}/></button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // --- ROOT APP ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const [masterAkun, setMasterAkun] = useState([]);

            useEffect(() => {
                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, setUser);
                return () => unsubscribe();
            }, []);

            // Fetch & Seed Master Akun
            useEffect(() => {
                if (!user) return;
                
                const akunColl = collection(db, 'artifacts', appId, 'public', 'data', 'master_akun');
                
                // Realtime Listener
                const unsubscribe = onSnapshot(akunColl, async (snapshot) => {
                    if (snapshot.empty) {
                        // SEEDING OTOMATIS JIKA KOSONG
                        console.log("Seeding Master Akun...");
                        const batch = writeBatch(db);
                        INITIAL_MASTER_DATA.forEach(acc => {
                            const newRef = doc(akunColl);
                            batch.set(newRef, acc);
                        });
                        await batch.commit();
                    } else {
                        const akunList = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                        setMasterAkun(akunList);
                    }
                });
                return () => unsubscribe();
            }, [user]);

            const menuItems = [
                { id: 'dashboard', label: 'Ringkasan', icon: <LayoutDashboard size={20} /> },
                { id: 'jurnal', label: 'Jurnal Umum', icon: <PlusCircle size={20} /> },
                { id: 'buku_besar', label: 'Buku Besar', icon: <BookOpen size={20} /> },
                { id: 'laporan', label: 'Laporan Keuangan', icon: <FileText size={20} /> },
                { id: 'pengaturan', label: 'Pengaturan Akun', icon: <Settings size={20} /> },
            ];

            return (
                <div className="flex h-screen overflow-hidden bg-gray-100">
                    {/* Sidebar */}
                    <aside className={`fixed inset-y-0 left-0 z-50 w-64 bg-emerald-800 text-white transform transition-transform duration-300 lg:relative lg:translate-x-0 ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        <div className="p-6 border-b border-emerald-700 flex justify-between items-center">
                            <h1 className="text-2xl font-bold tracking-tight">Kopkar AKM</h1>
                            <button className="lg:hidden" onClick={() => setSidebarOpen(false)}><X size={24}/></button>
                        </div>
                        <nav className="p-4 space-y-2">
                            {menuItems.map(item => (
                                <button key={item.id} onClick={() => { setActiveTab(item.id); setSidebarOpen(false); }} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${activeTab === item.id ? 'bg-emerald-600 shadow-md' : 'hover:bg-emerald-700'}`}>
                                    {item.icon} <span className="font-medium">{item.label}</span>
                                </button>
                            ))}
                        </nav>
                        <div className="absolute bottom-0 w-full p-4 border-t border-emerald-700 bg-emerald-900">
                             <div className="flex items-center gap-3">
                                <div className="w-8 h-8 rounded-full bg-emerald-500 flex items-center justify-center font-bold">A</div>
                                <div><p className="text-sm font-medium">Admin Keuangan</p><p className="text-xs text-emerald-300">ID: {user ? user.uid.slice(0,6) : '...'}</p></div>
                            </div>
                        </div>
                    </aside>

                    {/* Main Content */}
                    <div className="flex-1 flex flex-col min-w-0">
                        <header className="bg-white shadow-sm px-6 py-4 flex items-center justify-between">
                            <button className="lg:hidden" onClick={() => setSidebarOpen(true)}><Menu size={24}/></button>
                            <h1 className="font-bold text-gray-800 text-lg lg:text-xl">
                                {activeTab === 'dashboard' && 'Ringkasan Eksekutif'}
                                {activeTab === 'jurnal' && 'Input Jurnal (Double Entry)'}
                                {activeTab === 'buku_besar' && 'Buku Besar'}
                                {activeTab === 'laporan' && 'Laporan Keuangan'}
                                {activeTab === 'pengaturan' && 'Pengaturan Akun'}
                            </h1>
                            <div className="flex items-center gap-2">
                                <span className="text-xs font-bold px-3 py-1 bg-emerald-100 text-emerald-800 rounded-full">SAK EP v2.0</span>
                            </div>
                        </header>
                        <main className="flex-1 overflow-auto p-4 lg:p-6">
                            {activeTab === 'dashboard' && <Dashboard user={user} masterAkun={masterAkun}/>}
                            {activeTab === 'jurnal' && <JournalEntry user={user} masterAkun={masterAkun}/>}
                            {activeTab === 'buku_besar' && <Ledger user={user} masterAkun={masterAkun}/>}
                            {activeTab === 'laporan' && <Reports user={user} masterAkun={masterAkun}/>}
                            {activeTab === 'pengaturan' && <SettingsPage user={user} masterAkun={masterAkun}/>}
                        </main>
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
